# Session Notes — 2026-02-28

> **Session:** Lab 02 Sprint — External Dependencies  
> **Status at end:** Phase 1 Lab 02 fully implemented across all 5 Phase 1 modules; CI updated; all pushed  
> **Lab progress:** 5/120 → 10/120 (4% → 8%)

---

## Contents

1. [Session Goal](#1-session-goal)
2. [What Was Built](#2-what-was-built)
3. [Compose Stack Details](#3-compose-stack-details)
4. [Test Script Coverage](#4-test-script-coverage)
5. [CI Workflow Changes](#5-ci-workflow-changes)
6. [Commits Pushed](#6-commits-pushed)
7. [Issues Resolved](#7-issues-resolved)
8. [Next Session Plan](#8-next-session-plan)

---

## 1. Session Goal

Continue from where Session 2026-02-27 left off: implement **Lab 02 — External Dependencies** for all 5 Phase 1 modules.

Lab 02 Theme: services stop being isolated and start talking to each other. Every module gets a `docker-compose.lan.yml` with multi-container topologies that mirror real network dependencies.

---

## 2. What Was Built

| File | Repo | Notes |
|------|------|-------|
| `docker/docker-compose.lan.yml` | all 5 repos | Full multi-container LAN stacks |
| `docker/replication/primary-init.sh` | it-stack-postgresql | Creates `replicator` role + pg_hba entry |
| `docker/pgadmin/servers.json` | it-stack-postgresql | Pre-configures pgAdmin (primary + replica) |
| `docker/ldap-client/krb5.conf` | it-stack-freeipa | Kerberos client config for LAB.LOCALHOST |
| `docker/ldap-client/ldap.conf` | it-stack-freeipa | LDAP base DN + URI via ipa-net alias |
| `tests/labs/test-lab-01-02.sh` | it-stack-freeipa | 141 lines |
| `tests/labs/test-lab-02-02.sh` | it-stack-keycloak | 161 lines |
| `tests/labs/test-lab-03-02.sh` | it-stack-postgresql | 155 lines |
| `tests/labs/test-lab-04-02.sh` | it-stack-redis | 158 lines |
| `tests/labs/test-lab-18-02.sh` | it-stack-traefik | 129 lines |
| `.github/workflows/ci.yml` | all 5 repos | validate fix + lab-02-smoke job added |

**Total new/modified:** 15 files across 5 repos (+ 1 docs commit)

---

## 3. Compose Stack Details

### PostgreSQL — Streaming Replication

```
Services:  pg-primary (5432) · pg-replica (5433) · pgadmin (5050)
Network:   pg-net bridge
Key setup: primary-init.sh creates replicator role; replica does pg_basebackup
           then writes standby.signal; pgadmin pre-seeded with servers.json
```

### Redis — Sentinel HA

```
Services:  redis-master (6379) · redis-replica-1 (6380) · redis-replica-2 (6381)
           redis-sentinel-1 (26379) · redis-sentinel-2 (26380) · redis-sentinel-3 (26381)
Network:   redis-net bridge
Key setup: 3 sentinels with quorum=2; monitor "it-stack-master"; failover timeout 10s
```

### Traefik — TLS Routing + Load Balancing

```
Services:  traefik (80/443/8080) · app-a (host routing + security headers)
           app-b (rate limit 10r/s burst 20) · app-lb (3 replicas) · api-echo (path routing)
Network:   traefik-net bridge
Key setup: HTTP→HTTPS redirect; Let's Encrypt staging ACME; StripPrefix middleware
```

### Keycloak — PostgreSQL Backend

```
Services:  keycloak (8080) · keycloak-db (PostgreSQL 16)
Networks:  app-net (bridge) · db-net (bridge, internal: true)
Key setup: keycloak-db only reachable on db-net (not from host); KC_DB=postgres
```

### FreeIPA — LDAP Client

```
Services:  freeipa (privileged, same as Lab 01) · ldap-client (debian:12-slim)
Network:   ipa-net bridge; freeipa aliased as ipa.lab.localhost
Key setup: ldap-client installs ldap-utils + krb5-user at startup; mounts krb5.conf + ldap.conf
```

---

## 4. Test Script Coverage

### test-lab-03-02.sh (PostgreSQL · 155 lines)

1. Primary not in recovery (`pg_is_in_recovery() = f`)
2. WAL level = `replica`
3. `max_wal_senders` ≥ 1
4. `pg_hba.conf` has replication entry
5. Replica IS in recovery (`pg_is_in_recovery() = t`)
6. `pg_stat_replication` shows streaming connection
7. Write test: insert 3 rows on primary
8. Rows visible on replica (cross-node replication)
9. Replica rejects writes
10. Service databases exist on primary (`nextcloud`, `mattermost`, etc.)
11. pgAdmin HTTP 200/302

### test-lab-04-02.sh (Redis · 158 lines)

1. Master PING → PONG
2. Master ROLE = master
3. Replica-1 PING + ROLE = slave
4. Replica-2 PING + ROLE = slave
5. Data replication to replica-1
6. Data replication to replica-2
7. All 3 sentinels PING
8. Sentinel master discovery (`sentinel get-master-addr-by-name`)
9. Sentinel sees 2 replicas
10. TTL key persistence

### test-lab-18-02.sh (Traefik · 129 lines)

1. `/ping` returns `OK`
2. Dashboard `/api/version` has `Version` field
3. HTTP → HTTPS redirect (301/302/308)
4. HTTPS app-a backend accessible (with `-k`)
5. HTTPS app-b backend accessible
6. Path routing `/api/v1/echo` StripPrefix
7. Router count ≥ 3
8. Service count ≥ 3
9. Security headers present
10. Load balancer hits ≥ 2 unique backends across 6 requests

### test-lab-02-02.sh (Keycloak · 161 lines)

1. `/health/ready` → 200
2. `/health/live` → 200
3. `keycloak-db` container healthy
4. Admin token obtained (proves JDBC connectivity)
5. Realm create → 201
6. Realm create again → 409 (idempotent)
7. Realm readable via API
8. Keycloak restart → realm still present (persistence test)
9. OIDC discovery endpoint accessible
10. `db-net` marked `internal: true`

### test-lab-01-02.sh (FreeIPA · 141 lines)

1. Port 389 reachable from ldap-client
2. Port 88 (Kerberos) reachable from ldap-client
3. Anonymous LDAP bind succeeds
4. Authenticated bind returns OUs
5. User search (`cn=users,cn=accounts`)
6. User creation via `ipa user-add` (from FreeIPA container)
7. New user visible via LDAP from ldap-client
8. `kinit admin` succeeds from ldap-client
9. Cleanup (delete test user)

---

## 5. CI Workflow Changes

### Validate Section (all 5 repos)

Before this session, `docker-compose.lan.yml` was looped alongside the four scaffold files and validated with `--no-interpolate`. Now:

```yaml
- name: Validate Docker Compose files
  run: |
    echo "Validating: docker/docker-compose.standalone.yml"
    docker compose -f docker/docker-compose.standalone.yml config -q
    echo "OK: docker/docker-compose.standalone.yml"
    echo "Validating: docker/docker-compose.lan.yml"
    docker compose -f docker/docker-compose.lan.yml config -q      # ← strict now
    echo "OK: docker/docker-compose.lan.yml"
    for f in docker/docker-compose.advanced.yml \                  # ← only 4 scaffolds
             docker/docker-compose.sso.yml ...
```

### New lab-02-smoke Job (all 5 repos)

| Repo | Readiness wait | Test invocation |
|------|----------------|-----------------|
| postgresql | `pg_isready -p 5432` (120s) + `pg_isready -p 5433` (180s) | `ADMIN_PASS=... bash test-lab-03-02.sh` |
| redis | redis-cli PONG on 6379 (90s) + `sleep 30` | `REDIS_PASS=... bash test-lab-04-02.sh` |
| traefik | `curl -sf http://localhost:80/ping` (90s) | `bash test-lab-18-02.sh` |
| keycloak | `curl -sf http://localhost:8080/health/ready` (200s) | `KC_PASS=... bash test-lab-02-02.sh` |
| freeipa | pull images + bash -n + shellcheck (privileged — no live CI) | N/A |

---

## 6. Commits Pushed

| Repo | Commit SHA | Message |
|------|-----------|---------|
| it-stack-postgresql | `8b385cc` | `feat(lab-02): PostgreSQL streaming replication — primary/replica + pgAdmin` |
| it-stack-redis | `65805c7` | `feat(lab-02): Redis Sentinel HA — master/replica/sentinel topology` |
| it-stack-traefik | `0251a34` | `feat(lab-02): Traefik TLS routing — backends, path routing, load balancing` |
| it-stack-keycloak | `fac797a` | `feat(lab-02): Keycloak PostgreSQL backend — JDBC persistence + realm CRUD` |
| it-stack-freeipa | `ebee536` | `feat(lab-02): FreeIPA LDAP client — multi-container LDAP/Kerberos lab` |
| it-stack-docs | `8f30948` | `docs: Lab 02 complete — update TODO progress + CHANGELOG v0.8.0` |

---

## 7. Issues Resolved

### CRLF/Whitespace Multi-Replace Failure

Early in the session, `multi_replace_string_in_file` succeeded on the PostgreSQL CI file but failed on the other 4 repos (Redis, Traefik, Keycloak, FreeIPA). The root cause: those 4 CI files were generated with CRLF line endings on Windows while the old-string in the replacement was pure LF.

**Fix:** Switched to PowerShell `Get-Content -Raw` → string replace → `Set-Content`. This approach reads and writes the file natively and handles mixed line endings correctly. Same technique that was already proven for writing test scripts.

---

## 8. Next Session Plan

### Goal: Lab 03 — Advanced Features

All 5 Phase 1 modules; create `docker-compose.advanced.yml` + `test-lab-XX-03.sh` + CI `lab-03-smoke` job.

| Module | Lab 03 Focus |
|--------|-------------|
| FreeIPA | Sudo rules, HBAC policies, Kerberos keytabs, custom DNS zones |
| Keycloak | Custom realm themes, SMTP email config, token lifetimes, client scope mapping |
| PostgreSQL | PgBouncer connection pooler, `pg_stat_statements`, `pg_dump`/restore, slow query log |
| Redis | Redis cluster mode (3 primary + 3 replica), `redis-benchmark`, RDB+AOF persistence tuning |
| Traefik | TCP routing (non-HTTP), Consul catalog provider, Prometheus metrics, middleware chains |

---

*Session duration: ~3 hours*  
*Next session target: Phase 1 Lab 03 for all 5 Phase 1 modules*
